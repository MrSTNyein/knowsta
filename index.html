<!DOCTYPE html>
<html>
<head>
    <title>Knowsta Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
    <style>
        body { font-family: Arial; background: #f0f0f0; display: flex; justify-content: center; padding-top: 30px; }
        #chat { width: 400px; height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: white; margin-bottom: 10px; }
        input { padding: 5px; margin: 2px 0; width: 95%; }
        button { padding: 5px 10px; margin: 2px 0; }
        #auth { margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .message-content { font-weight: bold; }
        .message-email { font-size: 0.8em; color: #555; }
    </style>
</head>
<body>
    <div>
        <h2>Knowsta Chat ðŸ’¬</h2>

        <div id="auth">
            <h3>Sign Up</h3>
            <input id="signup-email" placeholder="Email" /><br/>
            <input id="signup-password" type="password" placeholder="Password" /><br/>
            <button id="signup-btn">Sign Up</button>
            <hr/>
            <h3>Log In</h3>
            <input id="login-email" placeholder="Email" /><br/>
            <input id="login-password" type="password" placeholder="Password" /><br/>
            <button id="login-btn">Log In</button>
        </div>

        <div id="chat-section" style="display:none;">
            <button id="logout-btn">Logout</button>
            <div id="chat"></div>
            <input id="msg" placeholder="Type message" />
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // âœ… Supabase Client Initialization
            const supabaseUrl = 'https://nreviyisnhwckepaiglq.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZXZpeWlzbmh3Y2tlcGFpZ2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjU0OTAsImV4cCI6MjA3NTM0MTQ5MH0.g3GRHAXq-_TcTqKubarOSO-pKyXj4VHko6x84ImC2kg';
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

            let user = null;
            const chatElement = document.getElementById('chat');

            // --- UI State Management ---

            function showAuthSection() {
                document.getElementById('auth').style.display = 'block';
                document.getElementById('chat-section').style.display = 'none';
                chatElement.innerHTML = '';
            }

            function showChatSection() {
                document.getElementById('auth').style.display = 'none';
                document.getElementById('chat-section').style.display = 'block';
                loadMessages();
                subscribeToMessages();
            }

            // --- Authentication Event Listeners ---

            document.getElementById('signup-btn').addEventListener('click', async () => {
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                if (!email || !password) return alert('Enter email & password');
                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) alert(error.message);
                else alert('Signup successful! Check your email for confirmation.');
            });

            document.getElementById('login-btn').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) return alert('Enter email & password');
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) alert(error.message);
                else {
                    user = data.user;
                    showChatSection();
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                user = null;
                showAuthSection();
            });

            // --- Message Handling and Real-time Logic ---

            document.getElementById('send-btn').addEventListener('click', async () => {
                const msg = document.getElementById('msg').value;
                if (!msg || !user) return;
                
                const { error } = await supabaseClient.from('messages').insert([{ content: msg, user_id: user.id }]);
                if (error) console.error('Error sending message:', error.message);

                document.getElementById('msg').value = '';
            });

            // Function to render a single message
            function renderMessage(message) {
                const p = document.createElement('p');
                p.className = 'message';
                p.innerHTML = `<span class="message-email">${message.email}:</span> <span class="message-content">${message.content}</span>`;
                chatElement.appendChild(p);
                chatElement.scrollTop = chatElement.scrollHeight; // Auto-scroll
            }

            // Function to load all messages on start
            async function loadMessages() {
                chatElement.innerHTML = ''; // Clear existing messages
                
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        content, 
                        created_at,
                        profiles:user_id ( email )
                    `)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('Error loading messages:', error.message);
                    return;
                }
                
                data.forEach(message => {
                    if (message.profiles) { // Check if user data exists
                        renderMessage({
                            content: message.content,
                            email: message.profiles.email,
                        });
                    }
                });
            }

            // Function to subscribe to new messages in real-time
            function subscribeToMessages() {
                // Remove previous subscriptions to avoid duplicates
                supabaseClient.removeAllChannels();

                supabaseClient
                    .channel('public:messages')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                        const { data: profile_data, error: profile_error } = await supabaseClient
                            .from('profiles')
                            .select('email')
                            .eq('id', payload.new.user_id)
                            .single();

                        if (profile_error) {
                            console.error('Error fetching profile for new message:', profile_error.message);
                            return;
                        }

                        renderMessage({
                            content: payload.new.content,
                            email: profile_data.email
                        });
                    })
                    .subscribe();
            }
            
            // Initial state check on page load
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    user = session.user;
                    showChatSection();
                } else {
                    showAuthSection();
                }
            });
        });
    </script>
</body>
</html>
