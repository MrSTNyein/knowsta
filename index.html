<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Knowsta Chat 💬</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  :root {
    --primary:#007aff; --primary-light:#0a84ff;
    --bg:#f2f2f7; --white:#fff;
    --text-dark:#1c1c1e; --text-light:#8e8e93; --border:#d1d1d6;
  }
  *{box-sizing:border-box;}
  body{margin:0;padding:0;font-family:'Inter',sans-serif;background:var(--bg);display:flex;justify-content:center;align-items:center;height:100vh;}
  .chat-app{width:100%;max-width:420px;height:85vh;display:flex;flex-direction:column;background:var(--white);border-radius:24px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;}
  header{background:var(--white);border-bottom:1px solid var(--border);padding:16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;}
  header h2{margin:0;font-size:1.4rem;color:var(--text-dark);}
  header button{background:var(--primary);color:var(--white);border:none;padding:6px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;}
  header button:hover{background:var(--primary-light);}
  #chat{flex:1;padding:16px;display:flex;flex-direction:column;overflow-y:auto;background:var(--bg);}
  .msg{display:flex;flex-direction:column;margin-bottom:14px;animation:fadeIn 0.2s ease;}
  .msg .meta{font-size:0.7rem;color:var(--text-light);margin-bottom:4px;display:flex;align-items:center;gap:6px;}
  .msg .meta img{width:20px;height:20px;border-radius:50%;}
  .msg .bubble{padding:12px 18px;font-size:0.95rem;max-width:75%;border-radius:20px;line-height:1.4;box-shadow:0 4px 8px rgba(0,0,0,0.05);word-break:break-word;}
  .msg.sent{align-items:flex-end;}
  .msg.sent .bubble{background:var(--primary);color:var(--white);border-bottom-right-radius:6px;border-top-right-radius:20px;}
  .msg.received{align-items:flex-start;}
  .msg.received .bubble{background:var(--white);color:var(--text-dark);border-bottom-left-radius:6px;border-top-left-radius:20px;}
  .input-area{display:flex;padding:12px;border-top:1px solid var(--border);background:var(--white);}
  .input-area input{flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:20px;font-size:1rem;outline:none;transition:all 0.2s ease;}
  .input-area input:focus{border-color:var(--primary);box-shadow:0 0 5px rgba(0,122,255,0.2);}
  .input-area button{background:var(--primary);color:var(--white);font-weight:600;padding:12px 18px;border-radius:20px;margin-left:8px;border:none;cursor:pointer;transition:all 0.2s ease;}
  .input-area button:hover{background:var(--primary-light);}
  #auth{text-align:center;padding:40px 24px;display:flex;flex-direction:column;justify-content:center;flex:1;}
  #auth h2{font-size:1.8rem;color:var(--text-dark);margin-bottom:20px;}
  #auth input{width:100%;padding:14px;margin:10px 0;border-radius:20px;border:1px solid var(--border);font-size:1rem;outline:none;transition:all 0.2s ease;}
  #auth input:focus{border-color:var(--primary);box-shadow:0 0 8px rgba(0,122,255,0.2);}
  #auth button{width:100%;padding:14px;margin-top:12px;border-radius:24px;font-weight:600;border:none;cursor:pointer;transition:all 0.2s ease;}
  #auth button:hover{opacity:0.9;}
  #google-btn{background:#4285f4;margin-top:16px;color:#fff;}
  #google-btn:hover{background:#357ae8;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<div class="chat-app">
  <header id="chat-header" style="display:none;">
    <h2>Knowsta Chat 💬</h2>
    <button id="logout-btn">Logout</button>
  </header>

  <div id="auth">
    <h2>Welcome</h2>
    <input id="phone-input" placeholder="+1234567890"/>
    <button id="send-otp-btn">Send OTP</button>
    <input id="otp-input" placeholder="Enter OTP" type="number" style="display:none;"/>
    <button id="verify-otp-btn" style="display:none;">Verify OTP</button>
    <button id="google-btn">Login with Google</button>
  </div>

  <div id="chat-section" style="display:none;">
    <div id="chat"></div>
    <div class="input-area">
      <input id="msg" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script>
  // 1️⃣ Initialize Supabase immediately
  const supabaseUrl = 'https://nreviyisnhwckepaiglq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZXZpeWlzbmh3Y2tlcGFpZ2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjU0OTAsImV4cCI6MjA3NTM0MTQ5MH0.g3GRHAXq-_TcTqKubarOSO-pKyXj4VHko6x84ImC2kg'; // Replace with your anon key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  document.addEventListener('DOMContentLoaded', () => {
    const authDiv = document.getElementById('auth');
    const chatSection = document.getElementById('chat-section');
    const chatHeader = document.getElementById('chat-header');
    const chatBox = document.getElementById('chat');
    const msgInput = document.getElementById('msg');

    const phoneInput = document.getElementById('phone-input');
    const otpInput = document.getElementById('otp-input');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const googleBtn = document.getElementById('google-btn');

    let user = null;
    let profileCache = {};

    function showChat(){
      authDiv.style.display='none';
      chatSection.style.display='flex';
      chatHeader.style.display='flex';
      loadMessages();
      subscribeToMessages();
    }

    function showAuth(){
      authDiv.style.display='flex';
      chatSection.style.display='none';
      chatHeader.style.display='none';
      chatBox.innerHTML='';
      phoneInput.value=''; otpInput.value='';
      otpInput.style.display='none';
      verifyOtpBtn.style.display='none';
      sendOtpBtn.style.display='block';
    }

    async function renderMessage(m){
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('msg', m.user_id===user?.id?'sent':'received');

      let profile = profileCache[m.user_id];
      if(!profile && m.profiles){ profile = m.profiles; profileCache[m.user_id]=profile; }

      const userName = profile?.email || profile?.phone || 'User';
      const avatar = profile?.avatar_url || 'https://i.pravatar.cc/40';
      const timestamp = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      msgDiv.innerHTML = `<div class="meta"><img src="${avatar}" /> ${userName} · ${timestamp}</div>
                          <div class="bubble">${m.content}</div>`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    async function loadMessages(){
      const {data,error} = await supabase.from('messages')
        .select('content,created_at,user_id,profiles:user_id(email,phone,avatar_url)')
        .order('created_at',{ascending:true});
      if(!error && data) data.forEach(renderMessage);
    }

    function subscribeToMessages(){
      supabase.removeAllChannels();
      supabase.channel('realtime:messages')
        .on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, async payload=>{
          let profile = profileCache[payload.new.user_id];
          if(!profile){
            const {data} = await supabase.from('profiles').select('email,phone,avatar_url').eq('id', payload.new.user_id).single();
            profile = data;
          }
          renderMessage({...payload.new, profiles:profile});
        }).subscribe();
    }

    async function sendMessage(){
      const msg = msgInput.value.trim();
      if(!msg || !user) return;
      await supabase.from('messages').insert([{content:msg, user_id:user.id}]);
      msgInput.value='';
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

    document.getElementById('logout-btn').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      user = null;
      showAuth();
    });

    sendOtpBtn.addEventListener('click', async ()=>{
      const phone = phoneInput.value;
      if(!phone) return alert('Enter phone number');
      const {error} = await supabase.auth.signInWithOtp({phone});
      if(error) return alert(error.message);
      alert('OTP sent!');
      sendOtpBtn.style.display='none';
      otpInput.style.display='block';
      verifyOtpBtn.style.display='block';
    });

    verifyOtpBtn.addEventListener('click', async ()=>{
      const phone = phoneInput.value;
      const token = otpInput.value;
      if(!phone || !token) return alert('Enter phone and OTP');
      const {data,error} = await supabase.auth.verifyOtp({phone, token, type:'sms'});
      if(error) return alert(error.message);
      await upsertProfile(data.user);
      user = data.user;
      showChat();
    });

    googleBtn.addEventListener('click', async ()=>{
      await supabase.auth.signInWithOAuth({provider:'google', options:{redirectTo:window.location.href}});
    });

    async function upsertProfile(userData){
      if(!userData) return;
      await supabase.from('profiles')
        .upsert({id:userData.id,email:userData.email,phone:userData.phone,avatar_url:userData.user_metadata?.avatar_url || null},{onConflict:'id'});
    }

    supabase.auth.onAuthStateChange((event, session)=>{
      if(session?.user){ user=session.user; showChat(); } else showAuth();
    });

    supabase.auth.getSession().then(({data:{session}})=>{ if(session?.user){ user=session.user; showChat(); } else showAuth(); });

  });
</script>
</body>
</html>
